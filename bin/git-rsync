#!/bin/bash
# Git Rsync

# Standard list of shell colors
###############################################################################

# color_txtblk='\e[0;30m' # Black - Regular
color_txtred='\e[0;31m' # Red
color_txtgrn='\e[0;32m' # Green
color_txtylw='\e[0;33m' # Yellow
# color_txtblu='\e[0;34m' # Blue
# color_txtpur='\e[0;35m' # Purple
# color_txtcyn='\e[0;36m' # Cyan
# color_txtwht='\e[0;37m' # White
# color_bldblk='\e[1;30m' # Black - Bold
# color_bldred='\e[1;31m' # Red
# color_bldgrn='\e[1;32m' # Green
# color_bldylw='\e[1;33m' # Yellow
# color_bldblu='\e[1;34m' # Blue
# color_bldpur='\e[1;35m' # Purple
# color_bldcyn='\e[1;36m' # Cyan
# color_bldwht='\e[1;37m' # White
# color_unkblk='\e[4;30m' # Black - Underline
# color_undred='\e[4;31m' # Red
# color_undgrn='\e[4;32m' # Green
# color_undylw='\e[4;33m' # Yellow
# color_undblu='\e[4;34m' # Blue
# color_undpur='\e[4;35m' # Purple
# color_undcyn='\e[4;36m' # Cyan
# color_undwht='\e[4;37m' # White
# color_bakblk='\e[40m'   # Black - Background
# color_bakred='\e[41m'   # Red
# color_badgrn='\e[42m'   # Green
# color_bakylw='\e[43m'   # Yellow
# color_bakblu='\e[44m'   # Blue
# color_bakpur='\e[45m'   # Purple
# color_bakcyn='\e[46m'   # Cyan
# color_bakwht='\e[47m'   # White
color_txtrst='\e[0m'    # Text Reset

# Standard output functions
###############################################################################

notice () {
    echo -en "$color_txtgrn"
    echo "$@"
    echo -en "$color_txtrst"
}

warn () {
    echo -en "$color_txtylw"
    echo "$@"
    echo -en "$color_txtrst"
}

err () {
    echo -en "$color_txtred"
    echo "$@"
    echo -en "$color_txtrst"
}

# Usage message
###############################################################################

usage () {
    CMD=$(basename $0)
    echo "Usage: $CMD (pull|push) BRANCH REMOTE_DIR"
    echo "       $CMD -h"
}

# Script main(s)
###############################################################################

main_default () {
    usage
    exit 0
}

_commit_uncommited_changes () {
    notice "Adding uncommitted changes to git"
    if ! git add -A . ; then
        err "Failed to add changes"
        exit 1
    fi

    notice "Committing changes"
    if git diff --cached --no-ext-diff --quiet --exit-code ; then
        notice "Nothing to commit"
    else
        if ! git commit -m "By $(id -un)@$(hostname) on $(date -Iseconds)" ; then
            err "Failed to commit changes"
            exit 1
        fi
    fi
}

main_pull () {
    notice "Checking out $BRANCH"
    if ! git checkout "$BRANCH" ; then
        err "Failed to checkout $BRANCH"
        exit 1
    fi

    _commit_uncommited_changes

    notice "Pulling from remote directory"
    if ! rsync -avz --exclude '.git/' './' "$REMOTE_DIR" ; then
        err "Failed to pull from remote directory"
        exit 1
    fi

    _commit_uncommited_changes
}

main_push () {
    notice "Checking out $BRANCH"
    if ! git checkout "$BRANCH" ; then
        err "Failed to checkout $BRANCH"
        exit 1
    fi

    _commit_uncommited_changes

    notice "Pushing to remote directory"
    if ! rsync -avz --exclude '.git/' "$REMOTE_DIR" './' ; then
        err "Failed to push to remote directory"
        exit 1
    fi
}

# Option and argument handling
###############################################################################

while getopts ":h" opt; do
    case ${opt} in
        h )
            usage
            exit 0
        ;;
        \? )
            err "Invalid Option: -$OPTARG"
            usage
            exit 1
        ;;
        : )
            err "Invalid Option: -$OPTARG requires an argument"
            usage
            exit 1
        ;;
    esac
done
shift $((OPTIND -1))

if [[ -z "$1" ]] ; then
    main_default
    exit 0
else
    SUBCOMMAND="$1"
    shift 1
fi

if [[ "$(type -t "main_${SUBCOMMAND}")" != "function" ]] ; then
    err "Invalid command: $SUBCOMMAND"
    usage
    exit 1
fi

BRANCH="$1"
shift 1
if [[ -z "$BRANCH" ]] ; then
    err "BRANCH not specified"
    usage
    exit 1
fi

REMOTE_DIR="$1"
shift 1
if [[ -z "$REMOTE_DIR" ]] ; then
    err "REMOTE_DIR not specified"
    usage
    exit 1
fi

GIT_DIR="$(git rev-parse --git-dir 2>/dev/null)"
if [[ "$?" -ne 0 ]] ; then
    err "Not in a git directory"
    exit 1
fi
REPO_DIR="$(dirname "$GIT_DIR)")"

notice "Moving into $REPO_DIR"
cd "$REPO_DIR"

main_${SUBCOMMAND} "$@"
exit 0
