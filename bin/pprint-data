#!/usr/bin/env python2
"""
Print the pickle/yaml/json/msgpack file from stdin to stdout.
"""

from __future__ import print_function

import sys
import json

def pprint(obj):
    print(json.dumps(obj, indent=2, ensure_ascii=False))

def process_yaml(fobj):
    import yaml
    pprint(yaml.load(fobj))

def process_pickle(fobj):
    import cPickle
    pprint(cPickle.load(fobj))

def process_json(fobj):
    for line in fobj:
        line = line.strip()
        if line:
            pprint(json.loads(line))

def process_msgpack(fobj):
    import msgpack
    unpacker = msgpack.Unpacker(fobj)
    for obj in unpacker:
        pprint(obj)

def main():
    if len(sys.argv) == 2:
        dtype, fname = sys.argv[1], "-"
    elif len(sys.argv) == 3:
        _, dtype, fname = sys.argv
    else:
        print("pprint-data - Pretty print data")
        print("Usage: pprint-data <dtype> [file]")
        sys.exit(1)

    try:
        process_fn = {
            "yaml"    : process_yaml,
            "pickle"  : process_pickle,
            "json"    : process_json,
            "msgpack" : process_msgpack
        }[dtype]
    except KeyError:
        print("Unknown data type: ", dtype)
        sys.exit(1)

    # Open the file
    if fname == "-":
        fobj = sys.stdin
    else:
        fobj = open(fname, "rb")

    try:
        process_fn(fobj)
    except IOError:
        pass

if __name__ == '__main__':
    main()
